name: Upload Release Assets

on:
  release:
    types: [published]

env:
  TAG: ${{ github.event.release.tag_name }}
  H2_PACKAGE_NAME: ${{ github.event.release.tag_name }}_h2_package
  QUICKSTART_VERSION: 1.3.8
  TEMP_DIR: ${{ github.workspace }}/temp
  DOWNLOADS_DIR: ${{ github.workspace }}/downloads
  MAC_JRE_URL: https://cdn.azul.com/zulu/bin/zulu21.42.19-ca-jre21.0.7-macosx_aarch64.zip
  WIN_JRE_URL: https://cdn.azul.com/zulu/bin/zulu21.42.19-ca-jre21.0.7-win_x64.zip

jobs:
  build_and_upload_assets:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}

      - name: Set up Zulu JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew :dgrv4_Gateway_serv:clean :dgrv4_Gateway_serv:bootJar

      - name: Create release directory
        run: mkdir -p $H2_PACKAGE_NAME/keys

      - name: Copy JAR and other assets
        run: |
          mv dgrv4_Gateway_serv/build/libs/* $H2_PACKAGE_NAME/
          mv dgrv4_Gateway_serv/keys/* $H2_PACKAGE_NAME/keys/
          mv $H2_PACKAGE_NAME/*.jar $H2_PACKAGE_NAME/digirunner.jar

      - name: Download Windows amd64 TPIsoftwareOSPO quickstart portable
        uses: robinraju/release-downloader@v1
        with:
          repository: TPIsoftwareOSPO/quickstart
          tag: v${{ env.QUICKSTART_VERSION }}
          fileName: "quickstart-portable_$QUICKSTART_VERSION_windows_amd64.zip"
          out-file-path: $DOWNLOADS_DIR

      - name: Download Macos apple chip TPIsoftwareOSPO quickstart portable
        uses: robinraju/release-downloader@v1
        with:
          repository: TPIsoftwareOSPO/quickstart
          tag: v${{ env.QUICKSTART_VERSION }}
          fileName: "quickstart-portable_$QUICKSTART_VERSION_darwin_arm64.tar.gz"
          out-file-path: $DOWNLOADS_DIR

      - name: Download Java 21 JRE from Azul Zulu
        run: |
          echo "Downloading Win Java JRE from: $WIN_JRE_URL"
          curl -L -o $DOWNLOADS_DIR/win/java_jre.zip $WIN_JRE_URL
          if [ $? -ne 0 ]; then
          echo "Error: Java JRE download failed from $WIN_JRE_URL"
          exit 1
          fi
          echo "Downloading Mac Java JRE from: $MAC_JRE_URL"
          curl -L -o $DOWNLOADS_DIR/mac/java_jre.zip $MAC_JRE_URL
          if [ $? -ne 0 ]; then
          echo "Error: Java JRE download failed from $MAC_JRE_URL"
          exit 1
          fi

      - name: Extract Java JRE packages
        run: |
          unzip -q $DOWNLOADS_DIR/win/java_jre.zip -d $TEMP_DIR/win && rm $DOWNLOADS_DIR/win/java_jre.zip
          unzip -q $DOWNLOADS_DIR/mac/java_jre.zip -d $TEMP_DIR/mac && rm $DOWNLOADS_DIR/mac/java_jre.zip
          mv $TEMP_DIR/win/zulu21.42.19-ca-jre21.0.7-win_x64 $TEMP_DIR/win/jre
          mv $TEMP_DIR/mac/zulu21.42.19-ca-jre21.0.7-macosx_aarch64 $TEMP_DIR/mac/jre
          echo "ls -l $TEMP_DIR/win/jre"
          ls -l $TEMP_DIR/win/jre 
          echo "ls -l $TEMP_DIR/mac/jre"
          ls -l $TEMP_DIR/mac/jre

      - name: Packet Mac Portable
        run: |
          mkdir $TAG_macos_arm6
          tar -xzf quickstart-portable_$QUICKSTART_VERSION_darwin_arm64.tar.gz -C $TEMP_DIR/$TAG_macos_arm6/quickstart
          mv  $TEMP_DIR/$TAG_macos_arm6/quickstart/quickstart-portable $TAG_macos_arm6/quickstart
          mv $TEMP_DIR/$TAG_macos_arm6/jre $TAG_macos_arm6
          mv deploys/quickstart/quickstart-mac.yaml $TAG_macos_arm6/quickstart.yaml
          cp -R $H2_PACKAGE_NAME/* $TAG_macos_arm6/digirunner


      - name: Zip release assets
        run: |
          zip -r $H2_PACKAGE_NAME.zip $H2_PACKAGE_NAME/
          mv mac $TAG_macos_arm64
          zip -r $TAG_macos_arm64.zip $TAG_macos_arm6/

#      - name: Upload Release Asset
#        uses: actions/upload-release-asset@v1.0.2
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        with:
#          upload_url: ${{ github.event.release.upload_url }}
#          asset_path: $H2_PACKAGE_NAME.zip
#          asset_name: $H2_PACKAGE_NAME.zip
#          asset_content_type: application/zip

      - name: Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: $TAG
          name: digirunner portable packages $TAG
          body: |
            Combined package generated from:
            - digiRunner-Open-Source: $TAG
            - TPIsoftwareOSPO/quickstart: $QUICKSTART_VERSION
          files: |
            $H2_PACKAGE_NAME.zip
            mac_arm64_${{ env.RELEASE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}